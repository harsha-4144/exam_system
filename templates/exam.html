<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <style>
        :root {
            --bg: #f4f6f8;
            --panel: #ffffff;
            --border: #dcdfe3;
            --primary: #2563eb;
            --dark: #111827;
            --panel-dark: #020617;
            --panel-border-dark: #1e293b;
            --radius: 8px;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #16a34a;
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            margin: 0;
            font-family: system-ui, sans-serif;
            background: var(--bg);
        }

        .header {
            height: 56px;
            background: var(--dark);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .timer {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            transition: color 0.3s ease;
        }

        .timer.warning {
            color: var(--warning);
            animation: pulse 1s infinite;
        }

        .timer.danger {
            color: var(--danger);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .page {
            height: calc(100vh - 56px);
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            gap: 12px;
            padding: 6px 14px;
            height: 100%;
        }

        .problem {
            width: 36%;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
        }

        .problem h2 {
            margin-top: 0;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 16px;
        }

        .time-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-info svg {
            color: var(--primary);
        }

        .right-column {
            width: 64%;
            min-width: 600px;
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 0;
        }

        .right-column.fullscreen {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 8px;
            padding-bottom: 4px;
            overflow: hidden;
            width: 100%;
            height: calc(100vh - 56px);
            background: var(--bg);
            z-index: 9999;
            padding: 8px;
        }

        .editor-panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            min-height: 200px;
            flex: 1;
            overflow: hidden;
        }

        .editor-area {
            flex: 1;
            position: relative;
        }

        #editor {
            position: absolute;
            inset: 0;
        }

        .controls {
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-dark);
            border-top: 1px solid var(--panel-border-dark);
        }

        .controls-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .language-select {
            background: #020617;
            color: #e5e7eb;
            border: 1px solid #1e293b;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }

        .language-select:hover {
            background: #1e293b;
        }

        .language-select option {
            background: #020617;
            color: #e5e7eb;
        }

        button {
            border: none;
            padding: 6px 14px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .run { 
            background: #4b5563; 
            color: white;
        }
        .run:hover {
            background: #374151;
        }

        .submit { 
            background: var(--primary); 
            color: white;
        }
        .submit:hover {
            background: #1d4ed8;
        }

        .fullscreen-btn {
            background: #020617;
            color: #e5e7eb;
            border: 1px solid #1e293b;
        }
        .fullscreen-btn:hover {
            background: #1e293b;
        }

        #splitter {
            height: 6px;
            background: linear-gradient(to bottom, #020617, #1e293b, #020617);
            cursor: row-resize;
            border-top: 1px solid #1e293b;
            border-bottom: 1px solid #1e293b;
            flex-shrink: 0;
        }

        .output-panel {
            background: var(--panel-dark);
            border: 1px solid var(--panel-border-dark);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            flex: 0.35;
            overflow: hidden;
        }

        .output-title {
            padding: 8px 12px;
            font-size: 12px;
            color: #94a3b8;
            border-bottom: 1px solid var(--panel-border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output-content {
            flex: 1;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #e5e7eb;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
            background: #0a0c10;
        }

        .input-line {
            display: flex;
            align-items: center;
            margin-top: 4px;
        }

        .prompt {
            color: #4ade80;
            margin-right: 8px;
            font-weight: bold;
        }

        .input-field {
            background: transparent;
            border: none;
            color: #e5e7eb;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            flex: 1;
            outline: none;
            padding: 2px 0;
        }

        .input-field::placeholder {
            color: #6b7280;
            font-style: italic;
        }

        .error-output {
            color: #f87171;
        }

        .success-output {
            color: #4ade80;
        }

        body.dragging {
            user-select: none;
            cursor: row-resize;
        }

        .example {
            margin-top: 12px;
            padding: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .example h4 {
            margin: 0 0 8px 0;
            color: var(--primary);
            font-size: 14px;
        }

        .example pre {
            margin: 6px 0;
            padding: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }

        .no-examples {
            color: #6b7280;
            font-style: italic;
            font-size: 14px;
            padding: 16px 0;
            text-align: center;
            border: 1px dashed #e5e7eb;
            border-radius: 6px;
            margin-top: 12px;
        }

        .language-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .terminal-header {
            display: flex;
            gap: 12px;
        }

        .terminal-prompt {
            color: #4ade80;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 14px;
            background: #94a3b8;
            animation: blink 1s infinite;
            vertical-align: middle;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>

<div class="header">
    <div>Coding Exam - {{ title }} <span class="language-badge" id="currentLang">Python</span></div>
    <div id="timer" class="timer">--:--</div>
</div>

<div class="page">
<div class="container">

<div class="problem">
    <h2>{{ title }}</h2>
    
    <div class="time-info">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
        </svg>
        <span>Time Limit: {{ time_limit_minutes }} minutes</span>
    </div>

    <div>{{ description|safe }}</div>

    {% if examples %}
        <h3 style="margin-top:20px;">Examples</h3>
        {% for ex in examples %}
            <div class="example">
                <h4>Example {{ loop.index }}</h4>
                <div><strong>Input:</strong></div>
                <pre>{{ ex[0] }}</pre>
                <div><strong>Output:</strong></div>
                <pre>{{ ex[1] }}</pre>
            </div>
        {% endfor %}
    {% else %}
        <div class="no-examples">
            No examples provided
        </div>
    {% endif %}
</div>

<div class="right-column" id="rightColumn">

<div class="editor-panel" id="editorPanel">
<form method="POST" action="/submit" id="codeForm" style="flex:1; display:flex; flex-direction:column;">
    <input type="hidden" name="question_id" value="{{ question_id }}">
    <input type="hidden" name="code" id="codeInput">
    <input type="hidden" name="language" id="languageInput" value="python">

    <div class="editor-area">
        <div id="editor"></div>
    </div>

    <div class="controls">
        <div class="controls-left">
            <select id="language" class="language-select">
                <option value="python">Python</option>
                <option value="c">C</option>
            </select>
            <button type="button" class="fullscreen-btn" id="fsBtn">Full Screen</button>
        </div>
        <div>
            <button type="button" class="run" onclick="runCode()">Run</button>
            <button type="submit" class="submit">Submit</button>
        </div>
    </div>
</form>
</div>

<div id="splitter"></div>

<div class="output-panel" id="outputPanel">
    <div class="output-title">
        <span class="terminal-header">
            <span>Terminal</span>
            <span class="terminal-prompt">$</span>
        </span>
        <span id="runStatus"></span>
    </div>
    <div id="output" class="output-content">
        <span style="color: #6b7280;">&#9654; Click 'Run' to execute your code.</span>
    </div>
</div>

</div>
</div>
</div>

<script>
// Monaco Editor configuration
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });

require(['vs/editor/editor.main'], function () {
    window.editor = monaco.editor.create(document.getElementById('editor'), {
        value: '',  // EMPTY EDITOR - students write everything from scratch
        language: 'python',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        renderLineHighlight: 'all',
        wordWrap: 'on',
        placeholder: 'Write your code here...'
    });
});

// Language selector - ONLY Python and C
const languageSelect = document.getElementById('language');
const languageInput = document.getElementById('languageInput');
const currentLang = document.getElementById('currentLang');

languageSelect.addEventListener('change', function() {
    const lang = this.value;
    
    // Update editor language
    monaco.editor.setModelLanguage(editor.getModel(), lang);
    
    // Update hidden input and display
    languageInput.value = lang;
    currentLang.textContent = this.options[this.selectedIndex].text;
    
    // Clear the editor when switching languages
    editor.setValue('');
});

// Full screen functionality
const fsBtn = document.getElementById("fsBtn");
const rightColumn = document.getElementById("rightColumn");

fsBtn.onclick = () => {
    rightColumn.classList.toggle("fullscreen");
    fsBtn.textContent = rightColumn.classList.contains("fullscreen")
        ? "Exit Full Screen"
        : "Full Screen";
    setTimeout(() => editor.layout(), 100);
};

document.addEventListener("keydown", e => {
    if (e.key === "Escape" && rightColumn.classList.contains("fullscreen")) {
        fsBtn.click();
    }
});

// Terminal state
let terminalState = {
    waitingForInput: false,
    inputBuffer: '',
    resolveInput: null,
    programOutput: '',
    currentInputLine: null
};

// Function to append to terminal
function appendToTerminal(text, className = '') {
    const output = document.getElementById('output');
    const span = document.createElement('span');
    span.textContent = text;
    if (className) span.className = className;
    output.appendChild(span);
    output.appendChild(document.createElement('br'));
    output.scrollTop = output.scrollHeight;
}

// Function to create input line
function createInputLine(promptText = 'Enter input: ') {
    const output = document.getElementById('output');
    
    // Create container for input line
    const inputLine = document.createElement('div');
    inputLine.className = 'input-line';
    
    // Create prompt
    const prompt = document.createElement('span');
    prompt.className = 'prompt';
    prompt.textContent = promptText;
    
    // Create input field
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'input-field';
    input.placeholder = 'Type here and press Enter...';
    input.autofocus = true;
    
    inputLine.appendChild(prompt);
    inputLine.appendChild(input);
    output.appendChild(inputLine);
    output.scrollTop = output.scrollHeight;
    
    return { inputLine, input };
}

// Handle input submission
// Run code
async function runCode() {
    const out = document.getElementById("output");
    const status = document.getElementById("runStatus");
    
    const code = editor.getValue();
    
    if (!code.trim()) {
        out.innerHTML = '';
        status.textContent = "";
        return;
    }
    
    // Clear terminal
    out.innerHTML = '';
    
    try {
        let inputData = '';
        let programFinished = false;
        let output = '';
        let error = null;
        
        while (!programFinished) {
            const data = new FormData();
            data.append("question_id", "{{ question_id }}");
            data.append("code", code);
            data.append("language", languageSelect.value);
            data.append("input", inputData);
            
            const response = await fetch("/run", { 
                method: "POST", 
                body: data 
            });
            const result = await response.json();
            
            if (result.needs_input) {
                // Program is waiting for input - show prompt and get input
                const userInput = await handleInput(result.prompt || '');
                inputData += userInput + '\n';
            } else {
                // Program finished
                programFinished = true;
                output = result.output;
                error = result.error;
            }
        }
        
        // Display ONLY the program output
        if (error) {
            out.textContent = error;
            status.textContent = "Error";
        } else {
            out.textContent = output;
            status.textContent = "Done";
        }
        
    } catch (err) {
        out.textContent = err;
        status.textContent = "Error";
    }
}

// Handle input submission
function handleInput(promptText) {
    return new Promise((resolve) => {
        const output = document.getElementById('output');
        
        // Create input line
        const inputLine = document.createElement('div');
        inputLine.style.display = 'flex';
        inputLine.style.alignItems = 'center';
        
        const input = document.createElement('input');
        input.type = 'text';
        input.style.background = 'transparent';
        input.style.border = 'none';
        input.style.color = '#e5e7eb';
        input.style.fontFamily = "'Courier New', monospace";
        input.style.fontSize = '13px';
        input.style.flex = '1';
        input.style.outline = 'none';
        input.style.padding = '2px 0';
        input.autofocus = true;
        
        // Add to output
        output.appendChild(inputLine);
        inputLine.appendChild(input);
        output.scrollTop = output.scrollHeight;
        
        // Handle enter key
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = input.value;
                
                // Show what was typed
                const textNode = document.createTextNode(value + '\n');
                output.insertBefore(textNode, inputLine);
                inputLine.remove();
                
                resolve(value);
            }
        });
        
        input.focus();
    });
}
// Splitter for resizing panels
const splitter = document.getElementById("splitter");
const editorPanel = document.getElementById("editorPanel");
const outputPanel = document.getElementById("outputPanel");

let dragging = false;

splitter.addEventListener("mousedown", () => {
    dragging = true;
    document.body.classList.add("dragging");
});

document.addEventListener("mouseup", () => {
    dragging = false;
    document.body.classList.remove("dragging");
});

document.addEventListener("mousemove", e => {
    if (!dragging) return;

    const rect = rightColumn.getBoundingClientRect();
    const y = e.clientY - rect.top;
    const minEditor = 200;
    const minOutput = 120;
    const maxEditor = rect.height - minOutput - splitter.offsetHeight;

    if (y < minEditor || y > maxEditor) return;

    editorPanel.style.flex = "none";
    outputPanel.style.flex = "none";
    editorPanel.style.height = y + "px";
    outputPanel.style.height = rect.height - y - splitter.offsetHeight + "px";

    editor.layout();
});

// Timer functionality
const timerElement = document.getElementById("timer");
{% if time_limit %}
    let totalSeconds = {{ time_limit }};
{% else %}
    let totalSeconds = 30 * 60;
{% endif %}

let timerInterval;

function updateTimer() {
    if (totalSeconds <= 0) {
        timerElement.textContent = "00:00";
        timerElement.className = "timer danger";
        
        clearInterval(timerInterval);
        
        if (confirm("Time's up! Your code will be submitted automatically.")) {
            document.getElementById("codeForm").submit();
        }
        return;
    }
    
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    
    timerElement.textContent = 
        String(minutes).padStart(2, "0") + ":" + 
        String(seconds).padStart(2, "0");
    
    if (totalSeconds <= 60) {
        timerElement.className = "timer danger";
    } else if (totalSeconds <= 300) {
        timerElement.className = "timer warning";
    } else {
        timerElement.className = "timer";
    }
    
    totalSeconds--;
}

updateTimer();
timerInterval = setInterval(updateTimer, 1000);

// Form submission
document.getElementById("codeForm").addEventListener("submit", function() {
    document.getElementById("codeInput").value = editor.getValue();
    document.getElementById("languageInput").value = languageSelect.value;
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter or Cmd+Enter to submit
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById("codeForm").submit();
    }
    // Ctrl+R or Cmd+R to run
    else if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        runCode();
    }
    // Ctrl+Shift+Space to format code
    else if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === ' ') {
        e.preventDefault();
        editor.getAction('editor.action.formatDocument').run();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    languageInput.value = 'python';
    currentLang.textContent = 'Python';
    editor.setValue('');
});
</script>

</body>
</html>
