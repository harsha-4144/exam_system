<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <style>
        :root {
            --bg: #f4f6f8;
            --panel: #ffffff;
            --border: #dcdfe3;
            --primary: #2563eb;
            --dark: #111827;
            --panel-dark: #020617;
            --panel-border-dark: #1e293b;
            --radius: 8px;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #16a34a;
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            margin: 0;
            font-family: system-ui, sans-serif;
            background: var(--bg);
        }

        .header {
            height: 56px;
            background: var(--dark);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .timer {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            transition: color 0.3s ease;
        }

        .timer.warning {
            color: var(--warning);
            animation: pulse 1s infinite;
        }

        .timer.danger {
            color: var(--danger);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .page {
            height: calc(100vh - 56px);
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            gap: 12px;
            padding: 6px 14px;
            height: 100%;
        }

        .problem {
            width: 36%;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
        }

        .problem h2 {
            margin-top: 0;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 16px;
        }

        .time-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-info svg {
            color: var(--primary);
        }

        .right-column {
            width: 64%;
            min-width: 600px;
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 0;
        }

        .right-column.fullscreen {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 8px;
            padding-bottom: 4px;
            overflow: hidden;
            width: 100%;
            height: calc(100vh - 56px);
            background: var(--bg);
            z-index: 9999;
            padding: 8px;
        }

        .editor-panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            min-height: 200px;
            flex: 1;
            overflow: hidden;
        }

        .editor-area {
            flex: 1;
            position: relative;
        }

        #editor {
            position: absolute;
            inset: 0;
        }

        .controls {
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-dark);
            border-top: 1px solid var(--panel-border-dark);
        }

        .controls-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        select {
            background: #020617;
            color: #e5e7eb;
            border: 1px solid #1e293b;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        button {
            border: none;
            padding: 6px 14px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .run { 
            background: #4b5563; 
            color: white;
        }
        .run:hover {
            background: #374151;
        }

        .submit { 
            background: var(--primary); 
            color: white;
        }
        .submit:hover {
            background: #1d4ed8;
        }

        .fullscreen-btn {
            background: #020617;
            color: #e5e7eb;
            border: 1px solid #1e293b;
        }
        .fullscreen-btn:hover {
            background: #1e293b;
        }

        #splitter {
            height: 6px;
            background: linear-gradient(to bottom, #020617, #1e293b, #020617);
            cursor: row-resize;
            border-top: 1px solid #1e293b;
            border-bottom: 1px solid #1e293b;
            flex-shrink: 0;
        }

        .output-panel {
            background: var(--panel-dark);
            border: 1px solid var(--panel-border-dark);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            flex: 0.35;
            overflow: hidden;
        }

        .output-title {
            padding: 4px 10px;
            font-size: 11px;
            color: #94a3b8;
            border-bottom: 1px solid var(--panel-border-dark);
        }

        .output-content {
            flex: 1;
            padding: 6px 10px;
            font-family: monospace;
            font-size: 13px;
            color: #e5e7eb;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        body.dragging {
            user-select: none;
            cursor: row-resize;
        }

        .example {
            margin-top: 12px;
            padding: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .example h4 {
            margin: 0 0 8px 0;
            color: var(--primary);
            font-size: 14px;
        }

        .example pre {
            margin: 6px 0;
            padding: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            overflow-x: auto;
        }

        .no-examples {
            color: #6b7280;
            font-style: italic;
            font-size: 14px;
            padding: 16px 0;
            text-align: center;
            border: 1px dashed #e5e7eb;
            border-radius: 6px;
            margin-top: 12px;
        }
    </style>
</head>
<body>

<div class="header">
    <div>Coding Exam - {{ title }}</div>
    <div id="timer" class="timer">--:--</div>
</div>

<div class="page">
<div class="container">

<div class="problem">
    <h2>{{ title }}</h2>
    
    <div class="time-info">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
        </svg>
        <span>Time Limit: {{ time_limit_minutes }} minutes</span>
    </div>

    <div>{{ description|safe }}</div>

    {% if examples %}
        <h3 style="margin-top:20px;">Examples</h3>
        {% for ex in examples %}
            <div class="example">
                <h4>Example {{ loop.index }}</h4>
                <div><strong>Input:</strong></div>
                <pre>{{ ex[0] }}</pre>
                <div><strong>Output:</strong></div>
                <pre>{{ ex[1] }}</pre>
            </div>
        {% endfor %}
    {% else %}
        <div class="no-examples">
            No examples provided
        </div>
    {% endif %}
</div>

<div class="right-column" id="rightColumn">

<div class="editor-panel" id="editorPanel">
<form method="POST" action="/submit" id="codeForm" style="flex:1; display:flex; flex-direction:column;">
    <input type="hidden" name="question_id" value="{{ question_id }}">
    <input type="hidden" name="code" id="codeInput">

    <div class="editor-area">
        <div id="editor"></div>
    </div>

    <div class="controls">
        <div class="controls-left">
            <select id="language">
                <option value="python">Python</option>
                <option value="cpp">C++</option>
                <option value="c">C</option>
                <option value="java">Java</option>
            </select>
            <button type="button" class="fullscreen-btn" id="fsBtn">Full Screen</button>
        </div>
        <div>
            <button type="button" class="run" onclick="runCode()">Run</button>
            <button type="submit" class="submit">Submit</button>
        </div>
    </div>
</form>
</div>

<div id="splitter"></div>

<div class="output-panel" id="outputPanel">
    <div class="output-title">Output</div>
    <div id="output" class="output-content">Output will appear here.</div>
</div>

</div>
</div>
</div>

<script>
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
require(['vs/editor/editor.main'], function () {
    window.editor = monaco.editor.create(document.getElementById('editor'), {
        value: `# Write your code here
# Read from input() and print the result
# Example for Sum of Two Numbers:
# a, b = map(int, input().split())
# print(a + b)`,
        language: 'python',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: false }
    });
});

document.getElementById("language").addEventListener("change", function () {
    monaco.editor.setModelLanguage(editor.getModel(), this.value);
});

const fsBtn = document.getElementById("fsBtn");
const rightColumn = document.getElementById("rightColumn");

fsBtn.onclick = () => {
    rightColumn.classList.toggle("fullscreen");
    fsBtn.textContent = rightColumn.classList.contains("fullscreen")
        ? "Exit Full Screen"
        : "Full Screen";
    setTimeout(() => editor.layout(), 100);
};

document.addEventListener("keydown", e => {
    if (e.key === "Escape" && rightColumn.classList.contains("fullscreen")) {
        fsBtn.click();
    }
});

function runCode() {
    const out = document.getElementById("output");
    out.textContent = "Running...";
    const data = new FormData();
    data.append("question_id", "{{ question_id }}");
    data.append("code", editor.getValue());

    fetch("/run", { method: "POST", body: data })
        .then(r => r.json())
        .then(res => {
            if (res.expected) {
                out.textContent = `Your Output:\n${res.output}\n\nExpected Output:\n${res.expected}`;
            } else {
                out.textContent = res.output || "No output";
            }
        })
        .catch(err => out.textContent = "Error: " + err);
}

const splitter = document.getElementById("splitter");
const editorPanel = document.getElementById("editorPanel");
const outputPanel = document.getElementById("outputPanel");

let dragging = false;

splitter.addEventListener("mousedown", () => {
    dragging = true;
    document.body.classList.add("dragging");
});

document.addEventListener("mouseup", () => {
    dragging = false;
    document.body.classList.remove("dragging");
});

document.addEventListener("mousemove", e => {
    if (!dragging) return;

    const rect = rightColumn.getBoundingClientRect();
    const y = e.clientY - rect.top;
    const minEditor = 200;
    const minOutput = 120;
    const maxEditor = rect.height - minOutput - splitter.offsetHeight;

    if (y < minEditor || y > maxEditor) return;

    editorPanel.style.flex = "none";
    outputPanel.style.flex = "none";
    editorPanel.style.height = y + "px";
    outputPanel.style.height =
        rect.height - y - splitter.offsetHeight + "px";

    editor.layout();
});

// Timer functionality
const timerElement = document.getElementById("timer");
{% if time_limit %}
    let totalSeconds = {{ time_limit }};  // Custom time limit from database
{% else %}
    let totalSeconds = 30 * 60;  // Default 30 minutes
{% endif %}

let timerInterval;

function updateTimer() {
    if (totalSeconds <= 0) {
        timerElement.textContent = "00:00";
        timerElement.className = "timer danger";
        
        clearInterval(timerInterval);
        
        // Auto-submit when time expires
        if (confirm("Time's up! Your code will be submitted automatically.")) {
            document.getElementById("codeForm").submit();
        }
        return;
    }
    
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    
    timerElement.textContent = 
        String(minutes).padStart(2, "0") + ":" + 
        String(seconds).padStart(2, "0");
    
    // Update timer color based on remaining time
    if (totalSeconds <= 60) { // Less than 1 minute
        timerElement.className = "timer danger";
    } else if (totalSeconds <= 300) { // Less than 5 minutes
        timerElement.className = "timer warning";
    } else {
        timerElement.className = "timer";
    }
    
    totalSeconds--;
}

// Start the timer
updateTimer();
timerInterval = setInterval(updateTimer, 1000);

// Save timer state in localStorage to persist across page refreshes
window.addEventListener('beforeunload', function() {
    localStorage.setItem('timer_{{ question_id }}', totalSeconds);
    localStorage.setItem('timer_start_{{ question_id }}', Date.now());
});

// Restore timer state if exists - BUT ONLY IF WE'RE CONTINUING AN ATTEMPT
document.addEventListener('DOMContentLoaded', function() {
    const savedSeconds = localStorage.getItem('timer_{{ question_id }}');
    const startTime = localStorage.getItem('timer_start_{{ question_id }}');
    const now = Date.now();
    
    // Check if we have a saved timer and if it's recent (within 2 hours)
    if (savedSeconds && startTime) {
        const elapsedSeconds = Math.floor((now - parseInt(startTime)) / 1000);
        const newTotalSeconds = parseInt(savedSeconds) - elapsedSeconds;
        
        // Only restore if there's still time left AND it's been less than 2 hours
        if (newTotalSeconds > 0 && elapsedSeconds < 7200) { // 2 hours = 7200 seconds
            totalSeconds = newTotalSeconds;
            console.log('Restored timer from localStorage:', totalSeconds, 'seconds remaining');
        } else {
            // Clear old timer data and start fresh
            localStorage.removeItem('timer_{{ question_id }}');
            localStorage.removeItem('timer_start_{{ question_id }}');
            console.log('Starting fresh timer');
        }
    } else {
        console.log('No saved timer found, starting fresh');
    }
    
    updateTimer();
});

// Clear timer when starting a fresh attempt
function clearTimerStorage() {
    localStorage.removeItem('timer_{{ question_id }}');
    localStorage.removeItem('timer_start_{{ question_id }}');
}

// Call this when the page loads to ensure we're not restoring an old timer
// unless we explicitly want to continue
clearTimerStorage();

document.getElementById("codeForm").addEventListener("submit", function () {
    document.getElementById("codeInput").value = editor.getValue();
    // Clear timer from localStorage on submit
    clearTimerStorage();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter or Cmd+Enter to submit
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById("codeForm").submit();
    }
    // Ctrl+R or Cmd+R to run
    else if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        runCode();
    }
});

// Warn user if they try to leave the page
window.addEventListener('beforeunload', function(e) {
    if (totalSeconds > 0 && totalSeconds < {{ time_limit if time_limit else 1800 }}) {
        e.preventDefault();
        e.returnValue = 'You have unsaved work and the timer is still running. Are you sure you want to leave?';
        return e.returnValue;
    }
});

</script>

</body>
</html>
